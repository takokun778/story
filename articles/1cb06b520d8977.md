---
title: "2022å¹´ã«è§¦ã£ãŸæŠ€è¡“ã§å¹´æœ«é§†ã‘è¾¼ã¿å€‹äººé–‹ç™º"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go", "kubernetes", "terraform", "okteto", "cockroachdb"]
published: true
---

# ã¯ã˜ã‚ã«

ã©ã†ã‚‚ã€è²§ä¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãŒè¶£å‘³ãª**ãŸã“ãã‚“**ã§ã™ã€‚
2022å¹´ã‚’æŒ¯ã‚Šè¿”ã‚‹ã¨äººç”Ÿã®ä¸­ã§ã‚‚ä¸€å¤§ã‚¤ãƒ™ãƒ³ãƒˆ**è»¢è·**ãŒã‚ã‚Šã¾ã—ãŸãŒã€
ãã‚“ãªã“ã¨ã‚’æŒ¯ã‚Šè¿”ã‚‹ã‚ˆã‚Šã‚‚æœ€å¾Œã¾ã§æ‰‹ã‚’å‹•ã‹ã—ãŸã„ã¨ã„ã†ã“ã¨ã§ã“ã‚“ãªé–‹ç™ºãƒ»è¨˜äº‹ã‚’æ›¸ãã¾ã™ã€‚ï¼ˆã¨ã„ã„ã¤ã¤æŒ¯ã‚Šè¿”ã‚Šè¨˜äº‹ã‚‚æ›¸ããŸã„ã€‚ï¼‰

# é–‹ç™ºã™ã‚‹ã‚¢ãƒ—ãƒª

https://zenn.dev/takokun/articles/8562a278bb2010

2022å¹´8æœˆã”ã‚ã«é–‹ç™ºã—ãŸGoè¨€èªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¿½åŠ ã‚’Slacké€šçŸ¥ã™ã‚‹ã‚¢ãƒ—ãƒªã‚’ã¾ãŸä½œã‚Šã¾ã™ã€‚
ã‚¤ãƒ³ãƒ•ãƒ©ã¾ã‚ã‚Šã‚’ã¡ã‚‡ã“ã¡ã‚‡ã“ã£ã¨å¤‰ãˆã¾ã™ã€‚

# æŠ€è¡“é¸å®š

## Golang

https://go.dev/

å¤§å¥½ãã§ã™ã€‚

## kubernates

https://kubernetes.io/

2022å¹´ã¡ã‚‡ã£ã¨ãšã¤è§¦ã‚‹æ©Ÿä¼šãŒå¢—ãˆã¦ãã¾ã—ãŸã€‚
cronjobã‚’ä½¿ã£ã¦ã¿ãŸã‹ã£ãŸã®ã§æ¡ç”¨ã—ã¾ã™ã€‚

## okteto

https://www.okteto.com/

ç„¡æ–™ã§k8sã®ç’°å¢ƒã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## CockroachDB

https://www.cockroachlabs.com/

ç„¡æ–™ã§5GBã®PostgreSQLç’°å¢ƒã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://github.com/cockroachdb/cockroach

CockroachDBã¯`Go`ã§è¨˜è¿°ã•ã‚ŒãŸåˆ†æ•£SQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚

## slack api

https://api.slack.com/

é€šçŸ¥ã«åˆ©ç”¨ã—ã¾ã™ã€‚
æœ¬å½“ã¯[LINE](https://developers.line.biz/ja/)ã‚’ä½¿ã£ã¦ã¿ãŸã‹ã£ãŸã§ã™ãŒèª¿ã¹ã‚‹æ™‚é–“ãŒãªã‹ã£ãŸã®ã§æ–­å¿µã—ã¾ã™ã€‚

## ~~Terraform Cloud~~

https://cloud.hashicorp.com/products/terraform

CockroachDBã®ãƒ‡ãƒ—ãƒ­ã‚¤å·®åˆ†ã‚’ç®¡ç†ã™ã‚‹ã®ã«åˆ©ç”¨ã—ã¾ã™ã€‚
ãŒã€tfstateã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ããªã‹ã£ãŸã®ã§ä»Šå›ã¯æ–­å¿µã—ã¾ã—ãŸã€‚

# æ§‹æˆå›³

å…¨ä½“åƒã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢å¼ã¨ãªã‚Šã¾ã™ã€‚

![](/images/1cb06b520d8977/1.png)

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒ¢ãƒãƒ¬ãƒã§å®Ÿè£…ã—ã¾ã™ã€‚

```basj
.
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ app // Goå®Ÿè£…ç®¡ç†
â”œâ”€â”€ aqua.yaml // å„ç¨®ãƒ„ãƒ¼ãƒ«ç®¡ç†
â”œâ”€â”€ k8s // manifestç®¡ç†
â””â”€â”€ terraform // infraç®¡ç†
```

appãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä»¥ä¸‹ã®æ§‹é€ ã«ãªã‚Šã¾ã™ã€‚
ãŠã‚ŒãŠã‚Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚

```bash
app
â”œâ”€â”€ Makefile // å„ç¨®ã‚³ãƒãƒ³ãƒ‰
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ cmd
â”‚   â”œâ”€â”€ migrate // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ notice // é€šçŸ¥ã‚³ãƒãƒ³ãƒ‰
â”‚       â””â”€â”€ main.go
â””â”€â”€ internal
    â”œâ”€â”€ adapter
    â”‚   â”œâ”€â”€ controller // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å±¤
    â”‚   â”‚   â””â”€â”€ tag.go
    â”‚   â”œâ”€â”€ gateway // ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤å±¤
    â”‚   â”‚   â”œâ”€â”€ github.go
    â”‚   â”‚   â”œâ”€â”€ rdb.go
    â”‚   â”‚   â””â”€â”€ tag.go
    â”‚   â””â”€â”€ notifier // é€šçŸ¥å±¤(ã“ã‚Œã¯ã©ã†ãªã‚“ã ã‚ã†...)
    â”‚       â”œâ”€â”€ channel.go
    â”‚       â””â”€â”€ tag.go
    â”œâ”€â”€ domain
    â”‚   â”œâ”€â”€ external // å¤–éƒ¨ä¾å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹
    â”‚   â”‚   â””â”€â”€ tag.go
    â”‚   â”œâ”€â”€ model
    â”‚   â”‚   â”œâ”€â”€ tag // tagãƒ¢ãƒ‡ãƒ«ã®Valueå€¤
    â”‚   â”‚   â”‚   â”œâ”€â”€ name.go
    â”‚   â”‚   â”‚   â”œâ”€â”€ owner.go
    â”‚   â”‚   â”‚   â””â”€â”€ repo.go
    â”‚   â”‚   â””â”€â”€ tag.go // tagãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«(IDãªã„ã®ã§å³å¯†ã«ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ãªã„...)
    â”‚   â””â”€â”€ repository // æ°¸ç¶šå±¤ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹
    â”‚       â”œâ”€â”€ github.go
    â”‚       â””â”€â”€ tag.go
    â”œâ”€â”€ driver // å¤–éƒ¨ã¨ã®æ¥ç¶šç³»
    â”‚   â”œâ”€â”€ config
    â”‚   â”‚   â””â”€â”€ config.go
    â”‚   â”œâ”€â”€ database
    â”‚   â”‚   â””â”€â”€ client.go
    â”‚   â””â”€â”€ slack
    â”‚       â””â”€â”€ client.go
    â””â”€â”€ usecase // ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å±¤
        â”œâ”€â”€ interactor // ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè£…
        â”‚   â””â”€â”€ tag.go
        â”œâ”€â”€ port // ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹
        â”‚   â””â”€â”€ tag.go
        â””â”€â”€ usecase.go // ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
```

# å®Ÿè£…

ãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ã¯ãªã‚“ã®å·¥å¤«ã‚‚ãªã„ä»¥ä¸‹ã®ã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚

1. GitHubã‹ã‚‰ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
1. ä¿å­˜æ¸ˆã¿ã®ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
1. å·®åˆ†ã‚’æ¯”è¼ƒ
1. å·®åˆ†ãŒã‚ã£ãŸå ´åˆã¯
1. å·®åˆ†ã‚’ä¿å­˜
1. å·®åˆ†ã‚’é€šçŸ¥

```go
package interactor

import (
	"context"
	"fmt"
	"log"

	"github.com/takokun778/2022/internal/domain/external"
	"github.com/takokun778/2022/internal/domain/model"
	"github.com/takokun778/2022/internal/domain/repository"
	"github.com/takokun778/2022/internal/usecase/port"
)

type NoticeTag struct {
	github        repository.GitHub
	tagRepository repository.Tag
	tagExternal   external.Tag
}

var _ port.NoticeTag = (*NoticeTag)(nil)

func NewNoticeTag(
	github repository.GitHub,
	tagRepository repository.Tag,
	tagExternal external.Tag,
) *NoticeTag {
	return &NoticeTag{
		github:        github,
		tagRepository: tagRepository,
		tagExternal:   tagExternal,
	}
}

func (nt *NoticeTag) Execute(ctx context.Context, input port.NoticeTagInput) (port.NoticeTagOutput, error) {
	dst, err := nt.github.FindAll(ctx, input.Owner, input.Repo)
	if err != nil {
		return port.NoticeTagOutput{}, fmt.Errorf("failed to list tags: %w", err)
	}

	src, err := nt.tagRepository.FindAll(ctx, input.Owner, input.Repo)
	if err != nil {
		return port.NoticeTagOutput{}, fmt.Errorf("failed to list tags: %w", err)
	}

	diff := model.TakeTags(dst, src)

	if len(diff) == 0 {
		log.Printf("no tags changed\n")

		return port.NoticeTagOutput{}, nil
	}

	if err := nt.tagRepository.SaveAll(ctx, diff); err != nil {
		return port.NoticeTagOutput{}, fmt.Errorf("failed to save tags: %w", err)
	}

	for _, tag := range diff {
		url := fmt.Sprintf("https://github.com/%s/%s/releases/tag/%s", input.Owner, input.Repo, tag.Name)

		msg := fmt.Sprintf("released %s\n\n%s", tag.Name, url)

		if err := nt.tagExternal.Notice(ctx, msg); err != nil {
			return port.NoticeTagOutput{}, fmt.Errorf("failed to notice tag: %w", err)
		}
	}

	return port.NoticeTagOutput{}, nil
}
```

# ãƒ‡ãƒ—ãƒ­ã‚¤

DockerHubã«ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

koã‚’å¥½ã‚“ã§ä½¿ã£ã¦ã„ã¾ã™ã€‚

https://github.com/ko-build/ko

äº‹å‰ã«`ko login -u ${USERNAME} -p ${PASSWORD} index.docker.io`ã‚’å®Ÿè¡Œã—ã¦ãŠãã¾ã™ã€‚

```Makefile
.PHONY: image
image:
	@(cd cmd/notice && ko build --sbom=none --bare --tags=latest ./ --platform=linux/amd64)
```

kubernates(okteto)ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

äº‹å‰ã«oktetoã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—`okteto login --token ${OKTETO_TOKEN}`ã‚’å®Ÿè¡Œã—ã¦ãŠãã¾ã™ã€‚

DBã¸ã®æ¥ç¶šæƒ…å ±ã‚„Slackã®ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã¯.gitignoreå¯¾è±¡ã®.envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ã¦envsubstã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«åŸ‹ã‚è¾¼ã‚€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ï¼ˆã“ã‚Œã¯æœãŸã—ã¦ã‚»ã‚­ãƒ¥ã‚¢ãªã®ã§ã—ã‚‡ã†ã‹...ï¼‰

```Makefile
.PHONY: kapply
kapply:
	@envsubst '$$IMAGE','$$DATABASE_URL','$$GITHUB_OWNER','$$GITHUB_REPOSITORY','$$SLACK_TOKEN','$$SLACK_CHANNEL_ID' < k8s/cronjob.yaml > tmp.yaml
	@kubectl apply -f tmp.yaml
	@rm tmp.yaml

.PHONY: kdelete
kdelete:
	@kubectl delete -f k8s/cronjob.yaml
```

ã¡ã‚ƒã‚“ã¨æ•´å‚™ã™ã‚‹ã®ãŒã‚ã‚“ã©ãã•ããªã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å®Ÿè¡Œã—ã¾ã—ãŸ...
GitOpsã‚’ã¡ã‚ƒã¡ã‚ƒã£ã¨ã§ãã‚‹ã‚ˆã†ã«æ¥å¹´ã¯æ‰‹æœ­ã‚’å¢—ã‚„ã—ãŸã„ã§ã™ã­ã€‚

## å‹•ä½œç¢ºèª

1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ä»¥ä¸‹ã§manifestã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: "2022"
spec:
  schedule: "0 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: "2022"
              image: ${IMAGE}
              imagePullPolicy: IfNotPresent
              env:
                - name: DATABASE_URL
                  value: ${DATABASE_URL}
                - name: GITHUB_OWNER
                  value: ${GITHUB_OWNER}
                - name: GITHUB_REPOSITORY
                  value: ${GITHUB_REPOSITORY}
                - name: SLACK_TOKEN
                  value: ${SLACK_TOKEN}
                - name: SLACK_CHANNEL_ID
                  value: ${SLACK_CHANNEL_ID}
          restartPolicy: Never
```

ç„¡äº‹ã«ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡ŒçµæœãŒãƒ­ã‚°å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚

```shell
2022-12-30 08:00:10.97 UTC2022-27873120-zfnjk20222022/12/30 08:00:10 released go1
2022-12-30 09:00:00.00 UTC2022-27873180-z7xbs[pod-event]Successfully assigned 2022-27873180-z7xbs to gke-cloud-app-xxxx
2022-12-30 09:00:01.00 UTC2022-27873180-z7xbs[pod-event]Pulling image ""
2022-12-30 09:00:06.00 UTC2022-27873180-z7xbs[pod-event]Successfully pulled image "" in 5.018382494s
2022-12-30 09:00:06.00 UTC2022-27873180-z7xbs[pod-event]Created container 2022
2022-12-30 09:00:07.00 UTC2022-27873180-z7xbs[pod-event]Started container 2022
2022-12-30 09:00:09.80 UTC2022-27873180-z7xbs20222022/12/30 09:00:09 no tags changed
```

# ãŠã‚ã‚Šã«

ä»Šå›ä½œæˆã—ãŸã‚‚ã®ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ãŠãã¾ã™ã€‚

https://github.com/takokun778/2022

å®Ÿè£…ã—ã¦ã¿ã¦

- CICDã¾ã‚ã‚Šã®æ‰‹æœ­ã‚’å¢—ã‚„ã—ãŸã„
- ãã‚ãã‚ãŠã‚ŒãŠã‚Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç”¨ã®ã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆã‚’ã—ãŸã„

ã¨æ€ã„ã¾ã—ãŸã€‚

ä»Šå¹´ä½•ã‚’è§¦ã£ãŸã‹ãªãã‚’æŒ¯ã‚Šè¿”ã‚ŠãªãŒã‚‰ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã™ã‚‹ã®ã‚‚çµæ§‹æ¥½ã—ã‹ã£ãŸã§ã™ã€‚
ã¾ãŸæ¥å¹´ã‚‚ã‚„ã‚ã†ã¨æ€ã„ã¾ã™ã€‚
